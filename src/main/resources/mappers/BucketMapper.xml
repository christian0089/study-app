<?xml version="1.0" encoding="UTF-8" ?>

<!DOCTYPE mapper
		PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
		"http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="BucketMapper">
	<select id="login" parameterType="JSONObject" resultType="Long">
		SELECT
			COALESCE( T1.USER_SEQNO, 0 ) AS USER_SEQNO
		FROM
			(
				SELECT
					COUNT(1),
					USER_SEQNO
				  FROM TB_USER
				 WHERE USER_ID = #{userId}
		   		   AND PWD = #{pwd}
		   		   AND SVC_GB = #{svcGb}
			) T1
	</select>
	
	<select id="selectBucketItems" parameterType="JSONObject" resultType="CamelJSONObject">
		SELECT BUCKET_SEQNO,
		       USER_SEQNO,
		       BUCKET_NM,
		       BUCKET_DSCR,
		       REP_IMG_URL,
		       REG_DTTM,
		       DEL_YN,
		       (CASE WHEN Count(*) OVER() > ( #{stNo} + 30 ) THEN 'Y'
		          	 ELSE 'N'
		       END) AS MORE_YN
		FROM   TB_BUCKET
		WHERE  DEL_YN = 'N'
		ORDER BY BUCKET_SEQNO DESC 
		LIMIT  #{stNo}, 30
	</select>
	
	<select id="selectBucketDtlItem" parameterType="JSONObject" resultType="CamelJSONObject">
		SELECT BUCKET_NM, 
			   REP_IMG_URL,
			   BUCKET_DSCR
		FROM   TB_BUCKET
		WHERE  BUCKET_SEQNO = #{bucketSeqno}
		AND    DEL_YN = 'N'
	</select>
	
	<select id="selectStoryItems" parameterType="JSONObject" resultType="CamelJSONObject">
		SELECT ROW_NUMBER() OVER(ORDER BY BUCKET_STORY_SEQNO DESC) AS no,
			   SOTRY_DSCR,
			   IMG_URL,
			   (CASE WHEN Count(*) OVER() > ( #{stNo} + 30 ) THEN 'Y'
	          	ELSE 'N'
	       	   END) AS MORE_YN
		FROM   TB_BUCKET_STORY
		WHERE  BUCKET_SEQNO = #{bucketSeqno}
		  AND  DEL_YN = 'N'
		LIMIT  #{stNo}, 30
	</select>
	
	<insert id="insertBucket" parameterType="JSONObject" useGeneratedKeys="true" keyProperty="bucketSeqno">
		INSERT INTO TB_BUCKET
		            (USER_SEQNO,
		             BUCKET_NM,
		             BUCKET_DSCR,
		             REP_IMG_URL,
		             REG_DTTM,
		             DEL_YN)
		VALUES     (#{userSeqno},
		            #{bucketNm},
		            #{bucketDscr},
		            #{repImgUrl},
		            now(),
		            'N')
	</insert>
	
	<insert id="insertStory" parameterType="JSONObject" useGeneratedKeys="true" keyProperty="bucketStorySeqno">
		INSERT INTO TB_BUCKET_STORY
		            (BUCKET_SEQNO,
		             SOTRY_DSCR,
		             IMG_URL,
		             REG_DTTM,
		             DEL_YN)
		VALUES     (#{bucketSeqno},
		            #{storyDscr},
		            #{imgUrl},
		            now(),
		            'N'); 
	</insert>
	
	<update id="delBucket" parameterType="JSONObject">
	/*[ SQL ID : BucketMapper.delStory]*/
		UPDATE TB_BUCKET
		   SET DEL_YN = 'Y'
		 WHERE BUCKET_SEQNO = #{bucketSeqno}
	</update>
</mapper>